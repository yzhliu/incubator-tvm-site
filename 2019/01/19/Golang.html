
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>TVM Golang Runtime for Deep Learning Deployment</title>
    
    <meta name="author" content="">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/custom-twitter/css/1.4.0/bootstrap.css" rel="stylesheet">
    <link href="/assets/themes/custom-twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/logo/tvm-logo.png">
  <link rel="shortcut icon" href="images/logo/tvm-logo.png">
  -->
  <link href="/images/logo/tvm-logo-square.png" rel="icon" type="image/png"/>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-75982049-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}

    gtag('js', new Date());
    gtag('config', 'UA-75982049-2');
  </script>

</head>

  <body>
    <div class="topbar">
      <div class="fill">
        <div class="container">
          <h2 id="logo-wrap">
            <a href="/" class="nav">
              <img src="/images/logo/tvm-logo-small-black.png" width="100px">
            </a>
          </h2>
          <ul class="nav" id="nav-bar">
            
            
            



  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      
    
  
    
      
      	
      	<li><a href="/community">Community</a></li>
      	
      
      
    
  
    
      
      	
      	<li><a href="/download">Download</a></li>
      	
      
      
    
  
    
      
      	
      	<li><a href="/about">About</a></li>
      	
      
      
    
  
    
      
      
    
  
    
      
      	
      	<li><a href="/vta">VTA</a></li>
      	
      
      
    
  
    
      
      
      	
      	<li><a href="/blog">Blog</a></li>
      	
      
    
  




            <li> <a href="https://tvm.apache.org/docs">Docs</a></li>
            <li> <a href="https://tvmconf.org">TVM Conference</a></li>
            <li> <a href="https://github.com/apache/incubator-tvm/">Github</a></li>
            <li> <a href="/asf">ASF</a></li>
          </ul>
        </div>
      </div>
    </div>
    
<div class="container">
<div class="content">
  <div class="row">
    <div class="span14">
      <h1>TVM Golang Runtime for Deep Learning Deployment </h1>
      <p class="post-meta">
        <time datetime="2019-01-19T00:00:00-08:00" itemprop="datePublished">
          Jan 19, 2019
        </time>
        
        • <span itemprop="author" itemscope itemtype="http://schema.org/Person">
          <span itemprop="name">Siva</span>
        </span>
        
      </p>
      <p class="post-meta">
        </p>
    </br>
    <h2 id="introduction">Introduction</h2>

<p>TVM is an open deep learning compiler stack to compile various deep learning models from different
frameworks to CPU, GPU or specialized accelerators.  TVM supports model compilation from a wide range
of front ends like Tensorflow, Onnx, Keras, Mxnet, Darknet, CoreML and Caffe2. TVM compiled modules
can be deployed on backends like LLVM (Javascript or WASM, AMD GPU, ARM or X86), NVidia GPU (CUDA),
OpenCL and Metal.</p>

<p>TVM supports runtime bindings for programming languages like Javascript, Java, Python, C++… and now Golang.
With a wide range of frontend, backend and runtime bindings, TVM enables developers to integrate and
deploy deep learning models from a variety of frameworks to a choice of hardware via many programming languages.</p>

<p>The TVM import and compilation process generates a graph JSON, a module and a params. Any application that
integrates the TVM runtime can load these compiled modules and perform inference. A detailed tutorial of module
import and compilation using TVM can be found at <a href="https://tvm.apache.org/docs//tutorials/">tutorials</a>.</p>

<p>TVM now supports deploying compiled modules through Golang. Golang applications can make use of this
to deploy the deep learning models through TVM. The scope of this blog is the introduction of <code class="language-plaintext highlighter-rouge">gotvm</code> package,
the package build process and a sample application using <code class="language-plaintext highlighter-rouge">gotvm</code> to load a compiled module and perform inference.</p>

<h2 id="package">Package</h2>

<p>The golang package <code class="language-plaintext highlighter-rouge">gotvm</code> is built on top of TVM’s C runtime interface. The API in this package
abstracts the native C types and provides Golang compatible types. The package source can be found
at <a href="https://github.com/dmlc/tvm/tree/master/golang">gotvm</a>.</p>

<p>This package leverages golang’s interface, slices, function closures and implicitly handles the
necessary conversions across API calls.</p>

<p style="text-align: center"><img src="/images/golang/TVM-Golang-Blog.png" alt="image" width="60%" /></p>
<center> Golang Interface over TVM Runtime </center>
<p></p>

<h2 id="how-to">How to</h2>

<p>As shown in the below diagram <code class="language-plaintext highlighter-rouge">gotvm</code> enables golang applications to integrate deep learning models
from various frameworks without the hassle of understanding each framework related interface API.
Developers can make use of TVM to import and compile deep learning models and generate TVM artifacts.
<code class="language-plaintext highlighter-rouge">gotvm</code> package provides golang friendly API to load, configure, feed input and get output.</p>

<p style="text-align: center"><img src="/images/golang/TVM-Golang-Flow.png" alt="image" width="100%" /></p>
<center> Import, Compile, Integrate and Deploy</center>
<p></p>

<p>TVM <a href="https://tvm.apache.org/docs//tutorials/#compile-deep-learning-models">Compile Deep Learning Models</a> tutorials
are available to compile models from all frameworks supported by the TVM frontend. This compilation process
generates the artifacts required to integrate and deploy the model on a target.</p>

<h2 id="api">API</h2>

<p><code class="language-plaintext highlighter-rouge">gotvm</code> package provides a handful of datatypes and API functions to initialize, load and infer
from a golang application. Like any other golang package we just need to import <code class="language-plaintext highlighter-rouge">gotvm</code> package here.</p>

<ul>
  <li>Module : The Module API can be used to load a TVM compiled module into TVM runtime and access any functions.</li>
  <li>Value : The Value API provides helper functions to set arguments or get return values in golang types like basic types or slices.</li>
  <li>Function : The Function API is useful for getting handles to functions and invoking them.</li>
  <li>Array : The Array API is useful for setting and getting Tensor data via golang slice.</li>
  <li>Context : The Context API contains helper functions to build backend context handles.</li>
</ul>

<h2 id="example">Example</h2>

<p>A simple example with inline documentation of loading a compiled module and performing inference is shown below.
For simplicity the error handling is ignored here, but is important in real applications.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">package</span> <span class="n">main</span>

<span class="c1">// Import compiled gotvm package.</span>
<span class="n">import</span> <span class="p">(</span>
    <span class="s">"./gotvm"</span>
<span class="p">)</span>

<span class="c1">// Some constants for TVM compiled model paths.</span>
<span class="c1">// modLib : Is the compiled library exported out of compilation.</span>
<span class="c1">// modJson : TVM graph JSON.</span>
<span class="c1">// modParams : Exported params out of TVM compilation process.</span>
<span class="k">const</span> <span class="p">(</span>
    <span class="n">modLib</span>    <span class="o">=</span> <span class="s">"./libdeploy.so"</span>
    <span class="n">modJSON</span>   <span class="o">=</span> <span class="s">"./deploy.json"</span>
    <span class="n">modParams</span> <span class="o">=</span> <span class="s">"./deploy.params"</span>
<span class="p">)</span>

<span class="c1">// main</span>
<span class="n">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Some util API to query underlying TVM and DLPack version information.</span>
    <span class="n">fmt</span><span class="p">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"TVM Version   : v%v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">gotvm</span><span class="p">.</span><span class="n">TVMVersion</span><span class="p">)</span>
    <span class="n">fmt</span><span class="p">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"DLPACK Version: v%v</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">gotvm</span><span class="p">.</span><span class="n">DLPackVersion</span><span class="p">)</span>

    <span class="c1">// Import tvm module (so).</span>
    <span class="n">modp</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">gotvm</span><span class="p">.</span><span class="n">LoadModuleFromFile</span><span class="p">(</span><span class="n">modLib</span><span class="p">)</span>

    <span class="c1">// Load module on tvm runtime - call tvm.graph_runtime.create</span>
    <span class="c1">// with module and graph JSON.</span>
    <span class="n">bytes</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">ioutil</span><span class="p">.</span><span class="n">ReadFile</span><span class="p">(</span><span class="n">modJSON</span><span class="p">)</span>
    <span class="n">jsonStr</span> <span class="o">:=</span> <span class="n">string</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>
    <span class="n">funp</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">gotvm</span><span class="p">.</span><span class="n">GetGlobalFunction</span><span class="p">(</span><span class="s">"tvm.graph_runtime.create"</span><span class="p">)</span>
    <span class="n">graphrt</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">funp</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">jsonStr</span><span class="p">,</span> <span class="n">modp</span><span class="p">,</span> <span class="p">(</span><span class="n">int64</span><span class="p">)(</span><span class="n">gotvm</span><span class="p">.</span><span class="n">KDLCPU</span><span class="p">),</span> <span class="p">(</span><span class="n">int64</span><span class="p">)(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">graphmod</span> <span class="o">:=</span> <span class="n">graphrt</span><span class="p">.</span><span class="n">AsModule</span><span class="p">()</span>


    <span class="c1">// Allocate input &amp; output arrays and fill some data for input.</span>
    <span class="n">tshapeIn</span>  <span class="o">:=</span> <span class="p">[]</span><span class="n">int64</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">3</span><span class="p">}</span>
    <span class="n">tshapeOut</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">int64</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1001</span><span class="p">}</span>
    <span class="n">inX</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">gotvm</span><span class="p">.</span><span class="n">Empty</span><span class="p">(</span><span class="n">tshapeIn</span><span class="p">,</span> <span class="s">"float32"</span><span class="p">,</span> <span class="n">gotvm</span><span class="p">.</span><span class="n">CPU</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">out</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">gotvm</span><span class="p">.</span><span class="n">Empty</span><span class="p">(</span><span class="n">tshapeOut</span><span class="p">)</span>
    <span class="n">inSlice</span> <span class="o">:=</span> <span class="n">make</span><span class="p">([]</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="mi">244</span> <span class="o">*</span> <span class="mi">244</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">rand</span><span class="p">.</span><span class="n">Seed</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">rand</span><span class="p">.</span><span class="n">Shuffle</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">inSlice</span><span class="p">),</span> <span class="n">func</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span><span class="n">inSlice</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                               <span class="n">inSlice</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand</span><span class="p">.</span><span class="n">Float32</span><span class="p">(),</span>
                                               <span class="n">rand</span><span class="p">.</span><span class="n">Float32</span><span class="p">()</span> <span class="p">})</span>
    <span class="n">inX</span><span class="p">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">inSlice</span><span class="p">)</span>

    <span class="c1">// Load params</span>
    <span class="n">bytes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ioutil</span><span class="p">.</span><span class="n">ReadFile</span><span class="p">(</span><span class="n">modParams</span><span class="p">)</span>
    <span class="n">funp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">graphmod</span><span class="p">.</span><span class="n">GetFunction</span><span class="p">(</span><span class="s">"load_params"</span><span class="p">)</span>
    <span class="n">funp</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>


    <span class="c1">// Set module input</span>
    <span class="n">funp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">graphmod</span><span class="p">.</span><span class="n">GetFunction</span><span class="p">(</span><span class="s">"set_input"</span><span class="p">)</span>
    <span class="n">funp</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="s">"input"</span><span class="p">,</span> <span class="n">inX</span><span class="p">)</span>

    <span class="c1">// Run or Execute the graph</span>
    <span class="n">funp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">graphmod</span><span class="p">.</span><span class="n">GetFunction</span><span class="p">(</span><span class="s">"run"</span><span class="p">)</span>
    <span class="n">funp</span><span class="p">.</span><span class="n">Invoke</span><span class="p">()</span>

    <span class="c1">// Get output from runtime.</span>
    <span class="n">funp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">graphmod</span><span class="p">.</span><span class="n">GetFunction</span><span class="p">(</span><span class="s">"get_output"</span><span class="p">)</span>
    <span class="n">funp</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">out</span><span class="p">)</span>

    <span class="c1">// Access output tensor data.</span>
    <span class="n">outIntf</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">out</span><span class="p">.</span><span class="n">AsSlice</span><span class="p">()</span>
    <span class="n">outSlice</span> <span class="o">:=</span> <span class="n">outIntf</span><span class="p">.([]</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1">// outSlice here holds flattened output data as a golang slice.</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">gotvm</code> extends the TVM packed function system to support golang function closures as packed functions.
<a href="https://github.com/dmlc/tvm/blob/master/golang/sample">Examples</a> available to register golang
closure as TVM packed function and invoke the same across programming language barriers.</p>

<h2 id="show-me-the-code">Show me the code</h2>

<ul>
  <li><a href="https://github.com/dmlc/tvm/blob/master/golang/src">Package Source</a></li>
  <li><a href="https://github.com/dmlc/tvm/blob/master/golang/sample">Examples</a></li>
</ul>

<h2 id="references">References</h2>

<ul>
  <li>[1] <a href="https://golang.org">Go Programming Lang</a></li>
  <li>[2] <a href="https://blog.golang.org/godoc-documenting-go-code">Go Documentation Guide Lines</a></li>
  <li>[3] <a href="https://golang.org/pkg/testing">Go Testcase Framework</a></li>
  <li>[4] <a href="https://golang.org/cmd/cgo">Go CFFI</a></li>
  <li>[5] <a href="https://blog.learngoprogramming.com/golang-variadic-funcs-how-to-patterns-369408f19085">Go Variadic Functions</a></li>
  <li>[6] <a href="https://github.com/jdeng/gomxnet">CFFI Ref</a></li>
  <li>[7] <a href="https://golang.org/pkg/runtime/#SetFinalizer">Go Finalizers</a></li>
</ul>

    </div>
  </div>
</div>
</div>


    





    <div class="container">

      <footer class="small">
        Apache TVM is an effort undergoing incubation at The Apache Software Foundation (ASF),
        sponsored by the <i>Apache Incubator</i>. Incubation is required
        of all newly accepted projects until a further review indicates that the infrastructure,
        communications, and decision making process have stabilized in a manner consistent with other
        successful ASF projects. While incubation status is not necessarily a reflection of the completeness
        or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.

        Copyright © 2020 The Apache Software Foundation. Apache TVM, Apache,
        the Apache feather, and the Apache TVM project logo are either trademarks or registered trademarks of the Apache Software Foundation.

        See also other useful <a href="/asf" class="footer-link">ASF links</a>:
        <a href="https://www.apache.org/" class="footer-link">Apache Homepage</a>,
        <a href="https://www.apache.org/licenses/" class="footer-link">License</a>
        <a href="https://www.apache.org/foundation/sponsorship.html" class="footer-link">Sponsorship</a>,
        <a href="https://www.apache.org/security/" class="footer-link">Security</a>
        <a href="https://www.apache.org/foundation/thanks.html" class="footer-link">Thanks</a>,
        <a href="https://www.apache.org/events/current-event.html" class="footer-link">Current Event</a>

      </footer>
    </div>
  </body>
</html>


